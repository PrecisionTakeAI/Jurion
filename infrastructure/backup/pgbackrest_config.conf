# pgBackRest Configuration for LegalAI Hub
# Meets Requirements: RTO <4 hours, RPO <5 minutes
# Enterprise-grade backup and disaster recovery for PostgreSQL

[global]
# Repository Configuration - Primary Backup Storage
repo1-type=s3
repo1-s3-bucket=legalai-backups-primary
repo1-s3-endpoint=s3.ap-southeast-2.amazonaws.com  # Australia region for data sovereignty
repo1-s3-region=ap-southeast-2
repo1-s3-key=[aws-access-key]
repo1-s3-key-secret=[aws-secret-key]
repo1-retention-full=7  # Keep 7 full backups (weekly)
repo1-retention-diff=4  # Keep 4 differential backups
repo1-retention-archive=7  # Keep 7 days of WAL archives

# Repository Configuration - Secondary Backup Storage (DR Site)
repo2-type=s3
repo2-s3-bucket=legalai-backups-dr
repo2-s3-endpoint=s3.ap-southeast-1.amazonaws.com  # Singapore region for DR
repo2-s3-region=ap-southeast-1
repo2-s3-key=[aws-access-key-dr]
repo2-s3-key-secret=[aws-secret-key-dr]
repo2-retention-full=14  # Extended retention for DR site
repo2-retention-diff=7
repo2-retention-archive=14

# Compression and Encryption
compress-type=lz4  # Fast compression for minimal impact
compress-level=3
cipher-type=aes-256-cbc  # AES-256 encryption for compliance
cipher-pass=[backup-encryption-passphrase]

# Performance Tuning
process-max=4  # Parallel processing for faster backups
archive-async=y  # Asynchronous archiving for better performance
archive-timeout=60  # 1 minute timeout to meet RPO <5 minutes

# Logging and Monitoring
log-level-console=warn
log-level-file=info
log-path=/var/log/pgbackrest
log-timestamp=y

# Buffer Settings for Large Databases
buffer-size=32MB  # Optimized for legal document storage
io-timeout=300  # 5 minutes for large file operations

[legalai-primary]
# Primary Database Configuration
pg1-host=postgresql-primary.legalai.local
pg1-host-user=postgres
pg1-path=/var/lib/postgresql/14/main
pg1-port=5432
pg1-socket-path=/var/run/postgresql

# Standby Configuration for High Availability
pg2-host=postgresql-standby.legalai.local
pg2-host-user=postgres
pg2-path=/var/lib/postgresql/14/main
pg2-port=5432

# Archive Command Integration
archive-push-queue-max=1GB  # Queue up to 1GB of WAL files
archive-check=y  # Verify archive integrity

# Recovery Options
recovery-option=primary_conninfo=host=postgresql-primary.legalai.local port=5432 user=replicator
recovery-option=restore_command='pgbackrest --stanza=legalai-primary archive-get %f "%p"'

[legalai-test]
# Test Environment Configuration (for DR testing)
pg1-host=postgresql-test.legalai.local
pg1-host-user=postgres
pg1-path=/var/lib/postgresql/14/test
pg1-port=5433